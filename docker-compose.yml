version: '3.8'

services:
  lithos-simulator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lithos-sim
    environment:
      - RUST_LOG=info
      - LITHOS_TICK_DURATION_US=1
      - LITHOS_BURST_DROPLETS=100
      - LITHOS_SIMULATION_DURATION_MS=50
    volumes:
      - ./output:/app/output
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '2'
          memory: 2G

  lithos-metrics:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lithos-metrics
    command: ["./lithos", "--export-metrics"]
    environment:
      - RUST_LOG=debug
    volumes:
      - ./metrics:/app/metrics
    depends_on:
      - lithos-simulator
    profiles:
      - analysis

volumes:
  output:
  metrics: